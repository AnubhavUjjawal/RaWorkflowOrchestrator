{% extends "airflow/master.html" %}
{% block title %}
{{ title }}
{% endblock %}

{% block head_css %}
{{ super() }}
<style>
  .CodeMirror {
    font-size: 14px;
    border: 1px solid #eee;
    height: 600px !important;
  }

  .CodeMirror-merge-gap {
    height: 600px !important;
  }

  .margin-top-lg {
    margin-top: 2em;
  }

  .padding-sm {
    padding: .5em;
  }

  #codebrickList {
    height: 480px;
    margin-bottom: 10px;
    overflow: scroll;
    -webkit-overflow-scrolling: touch;
  }

  .disabledDiv {
    pointer-events: none;
    opacity: 0.4;
  }

  .hover-cursor-pointer:hover {
    cursor: pointer;
  }

  /* css for tag buttons -- enable if tags are enabled */
  /* .section-button:focus,
  .clear-button:focus {
    outline: none;
    box-shadow: none; */
  }
</style>
<link rel="stylesheet" href="{{ url_for_asset('codemirror/codemirrorlib/codemirror.css') }}" />
<link rel="stylesheet" href="{{ url_for_asset('codemirror/theme/idea.css') }}" />
<link rel="stylesheet" href="{{url_for_asset('codemirror/addon/merge/merge.css')}}">
<link rel="stylesheet" href="{{url_for_asset('codemirror/addon/fold/foldgutter.css')}}">
<link rel="stylesheet" href="{{url_for_asset('codemirror/addon/dialog/dialog.css')}}">

{% endblock %}

{% block head_js %}
{{ super() }}
{% endblock %}

{% block content %}
<div style="margin-top: -1em;">
  <h3>{{filename}}</h3>
  <div class="col-md-8 col-sm-8 padding-sm codeEditorDiv">
    <!-- <ul class="nav nav-tabs" id="codeEditorTab"> -->
    <div class="pull-right hidden" id="editCodeAnchor">
      <a class="btn btn-primary" id="backToEditButton" data-toggle="tab" href="#code-content">
        <i class="fa fa-arrow-left" aria-hidden="true"></i>
        Back to edit mode
      </a>
      <button class="btn btn-primary" onclick="submitCode()">
        Save Code
        <i class="fa fa-floppy-o" aria-hidden="true"></i>
      </button>
    </div>
    <a class="btn btn-primary pull-right" data-toggle="tab" href="#review-content" id="reviewCodeAnchor">Review &
      Save</a>
    <!-- </ul> -->
    <div class="tab-content">
      <div id="code-content" class="tab-pane fade in active codeTab">
        <h4>Edit Code</h4>
        <textarea id="code" name="code" wrap="hard" style="min-width: 100%" rows="50">{{code}}</textarea>
      </div>
      <div id="review-content" class="tab-pane fade">
        <h4>Review Changes</h4>
        <div class="div-2" id="code-2"></div>
      </div>
    </div>
  </div>
  <div class="col-md-4 col-sm-4 codebricksDiv padding-sm" style="background-color: #d4d7dd; border-radius: 0.5rem;">
    <div data-toggle="tooltip" title="Add pre-built code recipes (prebuilt task and sub-DAG) in your current DAG code">
      <h3>
        Obelisk Code Bricks
        <span class="glyphicon glyphicon-info-sign" aria-hidden="true"
          style="font-size: 13px; margin-bottom: 0.5em;"></span>
      </h3>
    </div>

    <div class="input-group">
      <span class="input-group-addon"><i class="fa fa-search" aria-hidden="true"></i></span>
      <input type="text" class="form-control" id="codebrickSearch" placeholder="Search codebricks here..">
    </div>
    <br>
    <!-- This is where tags are added dynamically -->
    <!-- <div id="section-group">
    </div>
    <br> -->
    <ul class="list-group" id="codebrickList">

      <div class="panel-group" id="codebrickPanel">
        {% for section in snippets['sections'] %}
        {% set section_index = loop.index %}
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" data-parent="#codebrickPanel" href="#collapse-{{section_index}}">
                {{section}}
              </a>
            </h4>
          </div>
          <div id="collapse-{{section_index}}" class="panel-collapse collapse">
            <div class="panel-body">

              <div class="panel-group" id="section-{{section_index}}-panel">
                {% for sub_section in snippets['sections'][section] %}
                {% set sub_section_index = loop.index %}
                <div class="panel panel-default">
                  <div class="panel-heading">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" data-parent="#section-{{section_index}}-panel"
                        href="#sub-section-{{section_index}}-{{sub_section_index}}">{{sub_section}}
                      </a>
                    </h4>
                  </div>
                  <div id="sub-section-{{section_index}}-{{sub_section_index}}" class="panel-collapse collapse in">
                    <div class="panel-body">
                      <div class="panel-group" id="sub-section-{{section_index}}-{{sub_section_index}}-panel">
                        {% for codebrick in snippets['sections'][section][sub_section] %}
                        {% set codebrick_index = loop.index %}
                        <div class="panel">
                          <a data-toggle="collapse"
                            data-parent="#sub-section-{{section_index}}-{{sub_section_index}}-panel"
                            href="#codebrick-{{section_index}}-{{sub_section_index}}-{{codebrick_index}}"
                            ondragstart="setContentOfEvent(event,'codebrick-{{section_index}}-{{sub_section_index}}-{{codebrick_index}}')"
                            onclick="fetchSnippet('{{section_index}}-{{sub_section_index}}-{{codebrick_index}}')">
                            <h5 id="codebrick-title-{{section_index}}-{{sub_section_index}}-{{codebrick_index}}">
                              {{codebrick}}</h5>
                          </a>
                          <div id="codebrick-{{section_index}}-{{sub_section_index}}-{{codebrick_index}}"
                            class="panel-collapse collapse">
                            <div class="panel-body">
                              <div id="codebrick-desc-{{section_index}}-{{sub_section_index}}-{{codebrick_index}}"
                                class="desc">
                                {{ snippets['descriptions'][codebrick]['description']}}
                              </div>
                              <button class="btn btn-success pull-right codebrick-insert-btn"
                                onclick="insertSnip(this, '{{section_index}}-{{sub_section_index}}-{{codebrick_index}}')">
                                INSERT
                              </button>
                              <button class="btn btn-default pull-right" style="margin-right:5px"
                                onclick="editCodeBrick(this,'{{section_index}}-{{sub_section_index}}-{{codebrick_index}}')">
                                EDIT CODEBRICK
                              </button>
                              <br>
                              <pre class="margin-top-lg"
                                id="codebrick-code-{{section_index}}-{{sub_section_index}}-{{codebrick_index}}"
                                style="background-color: #ffffff;"></pre>
                            </div>
                          </div>
                        </div>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}

      </div>
      <!-- {% for section in snippets['sections'] %}
      {% set section_index = loop.index %}

      <div class="panel-group">
        <div class="panel panel-default" id="collapse-{{section_index}}">
          <div class="panel-heading">
            <a  data-toggle="collapse" data-parent="#codebrickList"
              href="#collapse-{{section_index}}">
              <h4 class="panel-title">{{section}}</h4>
            </a>
          </div>
          {% for sub_section in snippets['sections'][section] %}
          {% set sub_section_index = loop.index %}
          <div id="collapse-{{section_index}}-{{sub_section_index}}" class="panel-collapse collapse">
            <div class="panel-body">
              <a  data-toggle="collapse" data-parent="#collapse-{{section_index}}"
                href="#collapse-{{section_index}}-{{sub_section_index}}">
                {{sub_section}}
              </a>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      {% endfor %} -->
    </ul>
    <a class="btn btn-warning" style="width: 100%; margin-top: 1em;" onclick="addSnippetBackHandler(this)"
      data-toggle="modal" data-target="#addSnippet">
      Add a new code brick
    </a>
  </div>

  <div class="modal fade" id="editSnippet" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="edit-snippet-modal-title"></h4>
        </div>
        <form role="form" id="editSnippetForm" method="POST"
          action="{{ url_for('AddDagView.edit_snippet', filename=filename) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <div class="modal-body" id="dataEdit" style="max-height: 550px; overflow-y: scroll;">
            <div class="form-group">
              <label for="snippetTitle">Title</label>
              <input id="edit-snippet-title" type="text" class="form-control" name="title" required>
              <p class="help-block">Title can contain characters <code>A-Z, a-z, 0-9, _, -, space</code>.
            </div>
            <div class="form-group">
              <label for="snippetDescription">Description</label>
              <textarea class="form-control" placeholder="Enter new description here" name="description" rows="5"
                id="edit-snippet-desc"></textarea>
            </div>
            <div class="form-group">
              <label for="snippet">Section(s) and Sub-section(s)</label>
              <textarea class="form-control" name="sections" id="edit-snippet-section" rows="3">
              </textarea>
              <p class="help-block">Each entry in a new line, like : <code>section -> sub-section</code>.
            </div>
            <div class="form-group">
              <label for="snippet">Codebrick</label>
              <textarea class="form-control" name="snippet" id="snippetEdit">
              </textarea>
            </div>
          </div>
          <div class="modal-body" id="metadataEdit" style="max-height: 550px; overflow-y: scroll;">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-default" id="editSnippetBack"
              onclick="editSnippetBackHandler(this)">Back</button>
            <button type="button" class="btn btn-default" id="editSnippetNext"
              onclick="editSnippetNextHandler(this)">Next</button>
            <button type="submit" id="editSnippetSubmit" class="btn btn-primary">Submit</button>
          </div>
          <!-- <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Submit</button>
          </div> -->
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="addSnippet" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Add a codebrick to codebrick repo.</h4>
        </div>
        <form role="form" id="addSnippetForm" method="POST"
          action="{{ url_for('AddDagView.save_snippet', filename=filename) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <div class="modal-body" id="dataInput" style="max-height: 550px; overflow-y: scroll;">
            <div class="form-group">
              <label for="snippetTitle">Title</label>
              <input type="text" class="form-control" name="title" oninput="checkTitle(this)" required>
              <p class="help-block">Title can contain characters <code>A-Z, a-z, 0-9, _, -, space</code>.
            </div>
            <div class="form-group">
              <label for="snippetSection">Section(s) and Sub-Section(s)</label>
              <textarea class="form-control" name="section" id="snippetSection" rows="3"></textarea>
              <p class="help-block">Each entry in a new line, like : <code>section -> sub-section</code>.
            </div>
            <div class="form-group">
              <label for="snippetDescription">Description</label>
              <textarea class="form-control" name="description" rows="5"></textarea>
            </div>
            <div class="form-group">
              <label for="snippet">Codebrick</label>
              <textarea class="form-control" name="snippet" id="snippetInput"></textarea>
            </div>
          </div>
          <div class="modal-body" id="metadataInput" style="max-height: 550px; overflow-y: scroll;">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-default" id="addSnippetBack"
              onclick="addSnippetBackHandler(this)">Back</button>
            <button type="button" class="btn btn-default" id="addSnippetNext"
              onclick="addSnippetNextHandler(this)">Next</button>
            <button type="submit" id="addSnippetSubmit" class="btn btn-primary">Submit</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="insertSnippet" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" style="width: 80%; margin: auto;">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Replace placeholder values in codebrick.</h4>
        </div>
        <form id="insertSnippetForm" onsubmit="return false;">
          <div class="row">
            <div class="col-md-7">
              <div class="modal-body" id="showSnippetDoc" style="max-height: 550px; overflow-y: scroll;">
              </div>
            </div>
            <div class="col-md-5">
              <div class="modal-body" id="insertSnippetBody" style="max-height: 550px; overflow-y: scroll;">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <span class="pull-left" style="color: red;">* = mandatory field</span>
            <!-- <button type="button" class="btn btn-danger pull-left" onclick="insertSnippetWithoutTemplateParam(true);">Skip Optional</button> -->
            <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary"
              onclick="insertSnippetWithoutTemplateParam(true)">Insert</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- old code -->
<!-- Keep this textarea one liner -->
<textarea id="oldCode" hidden>{% if not new %}{{code}}{% endif %}</textarea>
{% endblock %}

{% block tail_js %}
{{ super() }}
<script type="text/javascript">
  window.onerror = function (e) {
    if (e == "Uncaught Error: Connection is disposed.") {
      return true;
    }
  }
</script>
<script src="{{ url_for('static', filename='js/jquery-3.4.1.min.js') }}"></script>
<script src="{{ url_for_asset('diff_match_patch.js') }}"></script>
<script src="{{ url_for_asset('codemirror/codemirrorlib/codemirror.js') }}"></script>
<script src="{{ url_for_asset('codemirror/mode/python/python.js') }}"></script>
<script src="{{ url_for_asset('codemirror/addon/search/searchcursor.js') }}"></script>
<script src="{{ url_for_asset('codemirror/addon/search/search.js') }}"></script>
<script src="{{ url_for_asset('codemirror/addon/dialog/dialog.js') }}"></script>
<script src="{{ url_for_asset('codemirror/addon/edit/matchbrackets.js') }}"></script>
<script src="{{ url_for_asset('codemirror/addon/edit/closebrackets.js') }}"></script>
<script src="{{ url_for_asset('codemirror/addon/comment/comment.js') }}"></script>
<script src="{{ url_for_asset('codemirror/addon/wrap/hardwrap.js') }}"></script>
<script src="{{ url_for_asset('codemirror/addon/fold/brace-fold.js') }}"></script>
<script src="{{ url_for_asset('codemirror/addon/merge/merge.js') }}"></script>
<script src="{{ url_for_asset('codemirror/addon/fold/foldcode.js') }}"></script>
<script src="{{ url_for_asset('codemirror/addon/fold/foldgutter.js') }}"></script>
<script src="{{ url_for_asset('codemirror/addon/fold/indent-fold.js') }}"></script>
<script src="{{ url_for_asset('codemirror/addon/selection/active-line.js') }}"></script>
<script src="{{ url_for_asset('codemirror/keymap/sublime.js') }}"></script>
<script src="{{ url_for('static', filename='js/language_server.js') }}"></script>
<script src="{{ url_for('static', filename='js/notify.js') }}"></script>
<script src="{{ url_for('static', filename='js/showdown.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery.validate.min.js') }}"></script>
<script type="text/javascript">

  var diffEditor, editSnippetEditor, addSnippetEditor, currSnippet,
    descStore = [], paramStore = [], sectionStore = [];
  var converter = new showdown.Converter();
  const theme = 'idea', keymap = 'sublime', indentUnit = 4;
  var editorConfigs = {
    lineNumbers: true,
    smartIndent: true,
    mode: 'python',
    styleActiveLine: true,
    autofocus: true,
    theme: theme,
    foldGutter: true,
    gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
    keyMap: keymap,
    indentUnit: indentUnit,
    indentWithTabs: false
  };

  function focusCodeEditor(timeout) {
    setTimeout(function () {
      langServer.codeEditor.focus();
    }, timeout);
  }

  function compareChanges() {
    var target = document.getElementById('code-2');
    target.innerHTML = '';
    diffEditor = CodeMirror.MergeView(target, {
      value: langServer.codeEditor.getValue(),
      origLeft: document.getElementById('oldCode').value,
      lineNumbers: true,
      mode: 'python',
      highlightDifferences: true,
      collapseIdentical: true,
      foldGutter: true,
      gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
      theme: theme,
      keyMap: keymap,
      indentUnit: indentUnit
    });
    diffEditor.edit.setOption('readOnly', true);
    diffEditor.edit.on('change', function (_cm, change) {
      langServer.codeEditor.setValue(_cm.getValue());
      langServer.codeEditor.refresh();
    });
  }

  function findPlaceholders(text) {
    var optional = text.match({{ '/{{[a-zA-Z0-9_-\s]+?}}/gm' }}) || [];
  var required = text.match({{ '/{%[a-zA-Z0-9_-\s]+?%}/gm' }}) || [];

  var placeholders = required.concat(optional);
  return new Set(placeholders);
  }

  function setContentOfEvent(event, index) {
    event.dataTransfer.setData("codebrick-index", index);
  }

  // function importUnimportedOperators(cursor) {
  //   var text;
  //   // adds operator to the line `from airflow.operators import <Operator1Name>, <Operator2Name>`
  //   if (new String(langServer.codeEditor.getValue()).match(/^from\sairflow\.operators\simport\s.*$/gm)) {
  //     text = new String(langServer.codeEditor.getValue()).replace(/^from\sairflow\.operators\simport\s.*$/gm, 'from airflow.operators import *');
  //   } else {
  //     text = 'from airflow.operators import *\n' + langServer.codeEditor.getValue() ;
  //   }
  //   langServer.codeEditor.setValue(text);
  //   langServer.codeEditor.getDoc().setCursor(cursor);
  // }

  function replaceTextInEditor(text) {
    var doc = langServer.codeEditor.getDoc();
    var cursor = doc.getCursor();
    text = '\n' + text + '\n';
    doc.replaceRange(text, cursor);
    // import unimported Operators
    // importUnimportedOperators(cursor);
    // langServer.codeEditor.focus() doesn't work without setTimeout !!
    focusCodeEditor(200);
  }

  function checkValidityofTemplateParams(skipOptional) {
    let valid = true;
    $("form#insertSnippetForm :input:not(:button)").each(function () {
      var input = $(this);
      input[0].setCustomValidity('');
    });
    if (!skipOptional) {
      $("form#insertSnippetForm :input:not(:button)").each(function () {
        var input = $(this);
        if (!input.val()) {
          input[0].setCustomValidity('This value is required !');
          valid = false && valid;
        } else {
          input[0].setCustomValidity('');
        }
      });
    }

    if (!$('#insertSnippetForm')[0].checkValidity()) {
      $('#insertSnippetForm')[0].reportValidity();
      return false;
    }
    return valid;
  }

  function insertSnippetWithoutTemplateParam(skip = false) {
    if (!checkValidityofTemplateParams(skip)) {
      return;
    }
    const formVal = {};
    $.each($("#insertSnippetForm").serializeArray(), function (_, kv) {
      formVal[kv.name] = kv.value;
    });
    var placeholders = findPlaceholders(currSnippet);
    var currSnippetCopy = (' ' + currSnippet).slice(1);
    if (placeholders) {
      placeholders.forEach(function (param) {
        formKey = param.replace('{{"{{"}}', '').replace('{{"}}"}}', '').replace('{{"{%"}}', '').replace('{{"%}"}}', '')
        currSnippetCopy = currSnippetCopy.replace(new RegExp(param, 'g'), formVal[formKey])
      })
    }
    $('#insertSnippet').modal('hide')
    replaceTextInEditor(currSnippetCopy)
  }

  function fetchSnippet(index, dragged) {
    // check if the codebrick has already been fetched
    if ($("#codebrick-code-" + index).text() == '') {
      var path = "{{ url_for('AddDagView.fetch_snippet', name=name) }}";
      var title = $("#codebrick-title-" + index).text().trim();
      // if it hasn't been fetched, fetch it
      fetch(path + title, { method: "GET" })
        .then(response => response.json()
        )
        .then(
          // inject response into webpage
          metadata => {
            // store parameters for inserting later
            paramStore.push({
              key: index,
              value: metadata.parameters
            });
            sectionStore.push({
              key: index,
              value: metadata.sections
            });
            $("#codebrick-code-" + index).text(metadata.snippet);
            // if this fetch call is due to a drag and drop,
            // call insertSnip after fetching
            if (dragged) {
              insertSnip(null, index);
            }
          }
        )
    }
    // if the codebrick is already fetched but the fetch call is due to a 
    // drag and drop, call insertSnip
    else if (dragged) {
      insertSnip(null, index);
    }
  };

  function editCodeBrick(btn, index) {
    var code = $('#codebrick-code-' + index).html();
    $("#editSnippet").modal("toggle");
    var title = $("#codebrick-title-" + index).text().trim();
    $(".edit-snippet-modal-title").text("Edit code for snippet : " + title);
    $("#edit-snippet-title").val(title);
    //  set description to stored Markdown text
    $("#edit-snippet-desc").text(descStore.filter((e) => e.key === "codebrick-desc-" + index)[0].value);
    $("#edit-snippet-section").text(sectionStore.filter((e) => e.key === index)[0].value);
    $("#snippetEdit").text(code);
  }

  {% raw %}

  function addSnippetBackHandler(btn) {
    $("#dataInput").show();
    $("#metadataInput").hide();
    $("#addSnippetNext").show();
    $("#addSnippetBack").hide();
    $("#addSnippetSubmit").hide();
  }

  function editSnippetBackHandler(btn) {
    $("#dataEdit").show();
    $("#metadataEdit").hide();
    $("#editSnippetNext").show();
    $("#editSnippetBack").hide();
    $("#editSnippetSubmit").hide();
  }

  function addSnippetNextHandler(btn) {
    // validate form on clicking next
    if (!jQuery("#addSnippetForm").valid()) {
      jQuery("#addSnippetForm").validate();
      return;
    }
    var text = addSnippetEditor.getValue();
    var mandatoryRaw = text.match(/{%.+?%}/g), mandatory;
    var optionalRaw = text.match(/{{.+?}}/g), optional;
    // if mandatory variables exist
    if (mandatoryRaw != null) {
      mandatory = mandatoryRaw.map(function (e) {
        // remove braces at the start and end
        return (e.substring(2, e.length - 2)).trim();
      });
    }
    // if optional variables exist
    if (optionalRaw != null) {
      optional = optionalRaw.map(function (e) {
        // remove braces at the start and end
        return (e.substring(2, e.length - 2)).trim();
      });
    }
    var metadataInputBody = "";
    if (mandatoryRaw == null && optionalRaw == null) {
      metadataInputBody = "There are no snippet variables to configure, you can submit the codebrick.";
    }
    else {
      if (mandatory != null) {
        mandatory.forEach(function (param) {
          temp =
            '<h4>' + param + '</h4>' +
            '<div class="form-group">' +
            '<label for="param-' + param + '-description"> Description </label>' +
            '<input type="text" class="form-control" name="param-' + param + '-description" required>' +
            '</div>' +
            '<div class="form-group">' +
            '<label for="param-' + param + '-parameter-type"> Parameter Type </label>' +
            '<input type="text" class="form-control" name="param-' + param + '-parameterType" required>' +
            '</div>' +
            '<div class="form-group">' +
            '<label for="param-' + param + '-example-value"> Example Value </label>' +
            '<input type="text" class="form-control" name="param-' + param + '-exampleValue" required>' +
            '</div>' +
            '<br/><hr/><br/>';
          metadataInputBody += temp;
        });
      }
      if (optional != null) {
        optional.forEach(function (param) {
          temp =
            '<h4>' + param + '</h4>' +
            '<div class="form-group">' +
            '<label for="param-' + param + '-description"> Description </label>' +
            '<input type="text" class="form-control" name="param-' + param + '-description" required>' +
            '</div>' +
            '<div class="form-group">' +
            '<label for="param-' + param + '-parameter-type"> Parameter Type </label>' +
            '<input type="text" class="form-control" name="param-' + param + '-parameterType" required>' +
            '</div>' +
            '<div class="form-group">' +
            '<label for="param-' + param + '-example-value"> Default Value </label>' +
            '<input type="text" class="form-control" name="param-' + param + '-defaultValue" required>' +
            '</div>' +
            '<div class="form-group">' +
            '<label for="param-' + param + '-example-value"> Example Value </label>' +
            '<input type="text" class="form-control" name="param-' + param + '-exampleValue" required>' +
            '</div>' +
            '<br/><hr/><br/>';
          metadataInputBody += temp;
        });
      }
    }
    $("#metadataInput").html(metadataInputBody);
    $("#dataInput").hide();
    $("#metadataInput").show();
    $("#addSnippetNext").hide();
    $("#addSnippetBack").show();
    $("#addSnippetSubmit").show();
  }

  function editSnippetNextHandler(btn) {
    // validate form on clicking next
    if (!jQuery("#editSnippetForm").valid()) {
      jQuery("#editSnippetForm").validate();
      return;
    }
    var text = editSnippetEditor.getValue();
    var mandatoryRaw = text.match(/{%.+?%}/g), mandatory;
    var optionalRaw = text.match(/{{.+?}}/g), optional;
    // if mandatory variables exist
    if (mandatoryRaw != null) {
      mandatory = mandatoryRaw.map(function (e) {
        // remove braces at the start and end
        return (e.substring(2, e.length - 2)).trim();
      });
    }
    // if optional variables exist
    if (optionalRaw != null) {
      optional = optionalRaw.map(function (e) {
        // remove braces at the start and end
        return (e.substring(2, e.length - 2)).trim();
      });
    }
    var metadataEditBody = "";
    if (mandatoryRaw == null && optionalRaw == null) {
      metadataEditBody = "There are no snippet variables to configure, you can submit the codebrick.";
    }
    else {
      if (mandatory != null) {
        mandatory.forEach(function (param) {
          temp =
            '<h4>' + param + '</h4>' +
            '<div class="form-group">' +
            '<label for="param-' + param + '-description"> Description </label>' +
            '<input type="text" class="form-control" name="param-' + param + '-description" required>' +
            '</div>' +
            '<div class="form-group">' +
            '<label for="param-' + param + '-parameter-type"> Parameter Type </label>' +
            '<input type="text" class="form-control" name="param-' + param + '-parameterType" required>' +
            '</div>' +
            '<div class="form-group">' +
            '<label for="param-' + param + '-example-value"> Example Value </label>' +
            '<input type="text" class="form-control" name="param-' + param + '-exampleValue" required>' +
            '</div>' +
            '<br/><hr/><br/>';
          metadataEditBody += temp;
        });
      }
      if (optional != null) {
        optional.forEach(function (param) {
          temp =
            '<h4>' + param + '</h4>' +
            '<div class="form-group">' +
            '<label for="param-' + param + '-description"> Description </label>' +
            '<input type="text" class="form-control" name="param-' + param + '-description" required>' +
            '</div>' +
            '<div class="form-group">' +
            '<label for="param-' + param + '-parameter-type"> Parameter Type </label>' +
            '<input type="text" class="form-control" name="param-' + param + '-parameterType" required>' +
            '</div>' +
            '<div class="form-group">' +
            '<label for="param-' + param + '-example-value"> Default Value </label>' +
            '<input type="text" class="form-control" name="param-' + param + '-defaultValue" required>' +
            '</div>' +
            '<div class="form-group">' +
            '<label for="param-' + param + '-example-value"> Example Value </label>' +
            '<input type="text" class="form-control" name="param-' + param + '-exampleValue" required>' +
            '</div>' +
            '<br/><hr/><br/>';
          metadataEditBody += temp;
        });
      }
    }
    $("#metadataEdit").html(metadataEditBody);
    $("#dataEdit").hide();
    $("#metadataEdit").show();
    $("#editSnippetNext").hide();
    $("#editSnippetBack").show();
    $("#editSnippetSubmit").show();
  }

  {% endraw %}

  // this commented out function handled click on tags

  // function handleSectionToggle(btn) {
  //   // clear all other section buttons
  //   handleSectionClear();
  //   var section = $(btn).text().trim();
  //   // change color of clicked button
  //   $(btn).removeClass('btn-default');
  //   $(btn).addClass('btn-primary');
  //   // filter and display codebricks with section
  //   var codebricks = $("#codebrickList").children().toArray();
  //   codebricks.map((codebrick) => {
  //     var sections = $(codebrick).attr("data-sections").split(',');
  //     if (sections.includes(section)) {
  //       $(codebrick).show();
  //     }
  //     else {
  //       $(codebrick).hide();
  //     }
  //   })
  // }

  // this commented out section handled click on CLEAR button for tags

  // function handleSectionClear() {
  //   var sectionButtons = $(".section-button").toArray();
  //   sectionButtons.map((button) => {
  //     $(button).removeClass('btn-primary');
  //     $(button).addClass('btn-default');
  //   })
  //   var codebricks = $("#codebrickList").children().toArray();
  //   codebricks.map((codebrick) => {
  //       $(codebrick).show();
  //   });
  // }

  function insertSnip(btn, index) {
    var text = $('#codebrick-code-' + index).text();
    var desc = $('#codebrick-desc-' + index).html();
    var snippetParams = paramStore.filter((e) => e.key === index)[0].value;
    var placeholders = findPlaceholders(text);
    if (placeholders.size) {
      // if have placeholders, need to fill their values before inserting.
      currSnippet = text;
      $('#insertSnippetBody').html('')
      if (snippetParams == "not found") {
        placeholders.forEach(function (param) {
          if (param.includes('{{"{{"}}') && param.includes('{{"}}"}}')) {
            param = param.replace('{{"{{"}}', '').replace('{{"}}"}}', '')
            temp = '<div class="form-group">' +
              '<label for="' + param + '">' + param + '</label>' +
              '<input type="text" class="form-control" name="' + param + '">' +
              '</div>'
          }
          else {
            param = param.replace('{{"{%"}}', '').replace('{{"%}"}}', '').trim()
            temp = '<div class="form-group">' +
              '<label for="' + param + '">' + param + '<span style="color:red;">* </span> </label>' +
              '<input type="text" class="form-control" name="' + param + '" required>' +
              '</div>'
          }
          $('#insertSnippetBody').append(temp);
        })
      }
      else {
        var parsedSnippetParams = JSON.parse(snippetParams);
        placeholders.forEach(function (param) {
          if (param.includes('{{"{{"}}') && param.includes('{{"}}"}}')) {
            param = param.replace('{{"{{"}}', '').replace('{{"}}"}}', '').trim()
            temp = '<div class="form-group">' +
              '<label for="' + param + '">' + param + '</label> ' +
              '<span class="badge">' + parsedSnippetParams[param]['parameterType'] + '</span>' +
              '<p>' + parsedSnippetParams[param]['description'] + '</br>' +
              'Eg. : ' + parsedSnippetParams[param]['exampleValue'] + '</p>' +
              '<input type="text" class="form-control" name="' + param + '" value="' + parsedSnippetParams[param]['defaultValue'] + '">' +
              '</div>'
          }
          else {
            param = param.replace('{{"{%"}}', '').replace('{{"%}"}}', '')
            temp = '<div class="form-group">' +
              '<label for="' + param + '">' + param + '<span style="color:red;">* </span> </label> ' +
              '<span class="badge">' + parsedSnippetParams[param]['parameterType'] + '</span>' +
              '<p>' + parsedSnippetParams[param]['description'] + '</p>' +
              '<input type="text" class="form-control" name="' + param + '"placeholder= "Eg. ' + parsedSnippetParams[param]['exampleValue'] + '"required>' +
              '</div>'
          }
          $('#insertSnippetBody').append(temp);
        })
      }
      // add parameter details to description
      if (snippetParams != "not found") {
        desc += '<h3>Parameters</h3>' +
          '<ul>';
        for (key in parsedSnippetParams) {
          desc += '<li><h4><code>'+key+'</code> <span class="badge">'+
            parsedSnippetParams[key]['parameterType']+'</span></h4>' +
            '<p>'+parsedSnippetParams[key]['description']+'</p>'

          console.log(parsedSnippetParams[key]);
        }
        desc+='</ul>'
      }
      $('#showSnippetDoc').html(desc);
      $('#insertSnippetBody').show();
      $('#showSnippetDoc').show();
      $('#insertSnippet').modal('show');
    }

    else {
      // adding a new line at the end of snippet.
      replaceTextInEditor(text)
    }
    // disable the button when snippet is inserted. The button will be enabled
    // after the codebrick div is toggled again.
    // $(btn).addClass('disabled');
  }

  $(document).ready(function () {

    // commented out code for TAGs Section

    // // tag filter and buttons
    // var sections = [];
    // // get all tags from elements
    // var sectionSpans = $(".section").toArray();
    // sectionSpans.map((section) => {
    //   sections.push($(section).text());
    // });
    // // select unique tags from all tags
    // let uniqueSections = [...new Set(sections)];
    // //  add button for unique tags
    // var sectionGroupHTML = '<h4> Filter by Tags:</h4>'
    // uniqueSections.map(section => {
    //   sectionGroupHTML += '<button type="button" class="section-button btn btn-default"' +
    //     'style="border-radius:23px; margin-right:5px"' +
    //     'onclick=handleSectionToggle(this)>' +
    //     section + '</button>'
    // })
    // sectionGroupHTML += '<button class="clear-button btn btn-link" onclick="handleSectionClear()"' +
    //   'style="border: none;;"><span class="glyphicon glyphicon-remove"></span> CLEAR</button>'
    // $("#section-group").html(sectionGroupHTML);

    // store raw descriptions and 
    // replace raw descriptions with markdown formatted descriptions
    var rawDesc = $(".desc").toArray();
    rawDesc.map((div) => {
      var key = $(div).attr('id');
      var value = $(div).text().trim();
      descStore.push({
        key: key,
        value: value
      });
    });
    rawDesc.map((e) => {
      var raw = $(e).text().trim();
      $(e).html(converter.makeHtml(raw));
    })

    // handle connection with language server
    var tries = 0;
    handleDisconnect = function () {
      // try for every 30 seconds
      every30Seconds = setTimeout(function () {

        ws = new WebSocket("{{language_server_url}}");
        langServer.connectToLangServer("{{language_server_url}}", "{{filename}}");
        tries += 1;

        ws.addEventListener('close', function (event) {
          if (tries == 0) {
            jQuery.notify("Code analysis and suggestions are currently unavailable. You can still code!", "warn")
            console.log("Language server connection closed, trying to reconnect ...")
          }
          handleDisconnect();
        });

        ws.addEventListener('open', function (event) {
          tries = 0
          console.log("Language server connected");
          jQuery.notify("Language server is connected! Code analysis and suggestions are available.", "success");
        });
      }, {{ reconnect_interval }});
  }

  // socket listener
  try {
    ws = new WebSocket("{{language_server_url}}");
    ws.addEventListener('close', function (event) {
      console.log("Language server connection closed, trying to reconnect ...")
      jQuery.notify("Code analysis and suggestions are currently unavailable. You can still code!", "warn")
      handleDisconnect();
    });
    ws.addEventListener('open', function (event) {
      tries = 0;
      console.log("Language server connected");
      jQuery.notify("Language server is connected! Code analysis and suggestions are available.", "success")
    });
  } catch (error) {
    console.log(error)
  }

  // connect to language server
  langServer.connectToLangServer("{{language_server_url}}", "{{filename}}");

  langServer.codeEditor.execCommand('goDocEnd');
  langServer.codeEditor.on('drop', function (cm, event) {
    if (event.dataTransfer.getData("codebrick-title")) {
      var coords = cm.coordsChar({
        left: event.x,
        top: event.y
      }, 'window');
      cm.getDoc().setCursor(coords);
      event.preventDefault();
      fetchSnippet(event.dataTransfer.getData("codebrick-index"), true);
    }
  })

  jQuery.noConflict();
  $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
    compareChanges();
  });

  $('[data-toggle="tooltip"]').tooltip();

  // var $codeBrickList = $('#codebrickList');
  // $codeBrickList.on('show.bs.collapse', '.collapse', function () {
  //   $codeBrickList.find('.collapse.in').collapse('hide');

  //   // enable all insert codebrick btns when the div is toggled.
  //   $('.codebrick-insert-btn').removeClass('disabled');
  // });

  $("[data-toggle='collapse']").click(function (event) {
    if (event.target.classList.contains('codebrick-insert-btn')) {
      event.stopPropagation();
    }
  });

  $('#addSnippet').on('shown.bs.modal', function (e) {
    $("#metadataInput").hide();
    $("#dataInput").show();
    $("#addSnippetNext").show();
    $("#addSnippetBack").hide();
    $("#addSnippetSubmit").hide();
    if (!addSnippetEditor) {
      var snipArea = document.getElementById('snippetInput');
      addSnippetEditor = CodeMirror.fromTextArea(snipArea, editorConfigs);
    }
  })

  $('#editSnippet').on('shown.bs.modal', function (e) {
    $("#metadataEdit").hide();
    $("#dataEdit").show();
    $("#editSnippetNext").show();
    $("#editSnippetBack").hide();
    $("#editSnippetSubmit").hide();
    if (!editSnippetEditor) {
      var snipArea = document.getElementById('snippetEdit');
      editSnippetEditor = CodeMirror.fromTextArea(snipArea, editorConfigs);
    }
  })

  $('#editSnippet').on('hide.bs.modal', function (e) {
    editSnippetEditor = null;
  })

  // WARNING: DO NOT TOUCH.
  // this method adds and removes classes based on which tab is active.
  $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
    var target = $(e.target).attr("href") // activated tab
    switch (target) {
      case '#review-content':
        $('.codebricksDiv').addClass('hidden');
        $('.codeEditorDiv').removeClass('col-md-8 col-sm-8');
        $('.codeEditorDiv').addClass('col-md-12 col-sm-12');
        $('#reviewCodeAnchor').addClass('hidden');
        $('#editCodeAnchor').removeClass('hidden');
        break;
      case '#code-content':
        $('.codebricksDiv').removeClass('hidden');
        $('.codeEditorDiv').removeClass('col-md-12 col-sm-12');
        $('.codeEditorDiv').addClass('col-md-8 col-sm-8');
        $('#reviewCodeAnchor').removeClass('hidden');
        $('#editCodeAnchor').addClass('hidden');
        langServer.codeEditor.refresh();
        break;
      default:
        $('.codebricksDiv').removeClass('hidden');
        $('.codeEditorDiv').removeClass('col-md-12 col-sm-12');
        $('.codeEditorDiv').addClass('col-md-8 col-sm-8');
        $('#reviewCodeAnchor').removeClass('hidden');
        $('#editCodeAnchor').addClass('hidden');
        langServer.codeEditor.refresh();
        break;
    }
  });

  $("#codebrickSearch").on("keyup", function () {
    var value = $(this).val().toLowerCase();
    $("#codebrickList a").filter(function () {
      $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
    });
  });
  });

  /**
 * sends a request to the specified url from a form. this will change the window location.
 * @param {string} path the path to send the post request to
 * @param {object} params the paramiters to add to the url
 * @param {string} [method=post] the method to use on the form
 */
  function post(path, params, method = 'post') {
    // The rest of this code assumes you are not using a library.
    // It can be made less wordy if you use one.
    const form = document.createElement('form');
    form.method = method;
    form.action = path;

    for (const key in params) {
      if (params.hasOwnProperty(key)) {
        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.name = key;
        hiddenField.value = params[key];

        form.appendChild(hiddenField);
      }
    }

    document.body.appendChild(form);
    form.submit();
  }

  function submitCode() {
    var path = "{{ url_for('AddDagView.editdag', filename=filename, new=new) }}";
    post(path, { code: langServer.codeEditor.getValue(), csrf_token: '{{ csrf_token() }}' });
  }

  function snippetExists(title) {
    const snippets = [
      {% for snippet_section in snippets %}
  {% for title in snippets[snippet_section] %}
  "{{title}}",
    {% endfor %}
  {% endfor %}
    ];
  if (snippets.includes(title)) return true;
  return false;
  }

  function checkTitle(input) {
    var validTitle = /^[\sA-Za-z0-9_@()-]+$/i.test(input.value);
    if (validTitle) {
      input.setCustomValidity('');
    } else {
      input.setCustomValidity('Not a valid code brick title.');
    }
    if (snippetExists(input.value)) {
      input.setCustomValidity('Code brick with that title already exists.');
    }
  }
</script>
{% endblock %}